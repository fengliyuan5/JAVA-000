# 1.使用 GCLogAnalysis.java 自己演练一遍串行 / 并行 /CMS/G1 的案例。
**测试电脑 8核32G内存 deepain系统**

执行命令

`java -XX:+UseSerialGC -Xms128m -Xmx128m -XX:+PrintGCDetails -XX:+PrintGCDateStamps GCLogAnalysis`

`java -XX:+UseParallelGC -Xms4096m -Xmx4096m -XX:+PrintGCDetails -XX:+PrintGCDateStamps GCLogAnalysis`
       
`java -XX:+UseConcMarkSweepGC -Xms4096m -Xmx4096m -XX:+PrintGCDetails -XX:+PrintGCDateStamps GCLogAnalysis`
       
`java -XX:+UseG1GC -Xms7196m -Xmx7196m -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -GCLogAnalysis`

## 1.1 串行 GC 分析

内存 | 现象 | ygc时间 | ogc时间 | 程序执行次数
:-: | :-: | :-: | :-: | :-: 
128 | OutOfMemoryError |...|...|...|
256 | OutOfMemoryError |...|...|...|
512 | 正常运行 | 0.02 | 0.04 | 12000左右|
1024 | 正常运行 | 0.01~0.05 | 无 | 16000~17000|
2048 | 正常运行 | 0.05~0.06 | 无 | 16000~17000|
4096 | 正常运行 | 0.07~0.09 | 无 | 15800~16600|
6144 | 正常运行 | 0.09~0.11 | 无 | 12500~13000|
8192 | 正常运行 | 0.1~0.11 | 无 | 10650~11600|

**总结**
串行 GC 随着内存的增大，垃圾回收的时间也增大，性能一定范围内先上升，在下降的趋势。后期随着内存增大，没有发生ogc，因为ygc中的很多对象都被回收调了，进入老年代的对象很少，老年代没有满。

## 1.2 并行 GC 分析 

**需要手动设置 -XX:SurvivorRatio=10 如果不加参数的话 默认值不固定，当内存小的时候，默认可能 from、to、eden区大小一样，导致在512的时候，程序执行次数不及串行gc，因为eden区太小了，本程序大部分对象都在eden区被回收了。**

内存 | 现象 | ygc时间 | ogc时间 | 程序执行次数
:-: | :-: | :-: | :-: | :-: 
128 | OutOfMemoryError |...|...|...|
256 | OutOfMemoryError |...|...|...|
512 | 正常运行 | 0.004~0.007 | 0.03~0.04 | 12000左右|
1024 | 正常运行 | 0.01~0.02 | 0.01 | 18000~19000|
2048 | 正常运行 | 0.012~0.019 | 无 | 22000~22900|
4096 | 正常运行 | 0.02~0.03 | 无 | 20500~21500|
6144 | 正常运行 | 0.03~0.04 | 无 | 17700~17800|
8192 | 正常运行 | 0.02~0.03 | 无 | 14000~15000|

**总结：并行gc回收效率要比串行的要快，随着内存的增大，性能在一定范围内先上升后下降，相对串行gc，内存的使用范围更大一些。性能要好于串行gc。**

## 1.3 CMS GC 分析

内存 | 现象 | ygc时间 | ogc时间 | 程序执行次数
:-: | :-: | :-: | :-: | :-: 
128 | OutOfMemoryError |...|...|...|
256 | 正常执行或oom |...|...|...|4400左右
512 | 正常运行 | 0.02~0.03 | 0.03~0.04 | 12000左右|
1024 | 正常运行 | 0.01~0.04 | 短 | 17500左右|
2048 | 正常运行 | 0.01~0.05 | 0.01 | 17600~18600|
4096 | 正常运行 | 0.01~0.06 | 无 | 16800~17400|
6144 | 正常运行 | 0.01~0.06 | 无 | 16400~17400|
8192 | 正常运行 | 0.01~0.07 | 无 | 16300~16500|

**总结：CMS 在一定区间内，例如1~4g之间性能不敢并行gc高，但是很稳定，当超过4g以后，CMS优势出来一些，但是并不明显，CMS的暂停时间很稳定**


## 1.4 G1 GC 分析

内存 | 现象 | ygc时间 | ogc时间 | 程序执行次数
:-: | :-: | :-: | :-: | :-: 
128 | OutOfMemoryError |...|...|...|
256 | 正常执行或oom |...|...|...|4900左右
512 | 正常运行 | 0.038-0.047 |  | 11600-12500|
1024 | 正常运行 | 0.014~0.035 |  | 16700-18000|
2048 | 正常运行 | 0.009~0.013 | 无 | 14000~17000|
4096 | 正常运行 | 0.008~0.019 | 无 | 17000~20000|
6144 | 正常运行 | 0.012~0.018 | 无 | 17000~19200|
8192 | 正常运行 | 0.011~0.024 | 无 | 19000~20300|

**总结：G1 在小于4g时优势不大，但是大于4g的时候，性能是逐渐提高，并且它的暂停时间一直很稳定**

**在实际生产中，建议2~内存时候，跟场景在选择并行和CMS选择，如果内存大于4g，建议优先考虑G1**

# 2.使用压测工具（wrk 或 sb），演练 gateway-server-0.0.1-SNAPSHOT.jar 示例。

